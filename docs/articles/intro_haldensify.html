<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Highly Adaptive Lasso Conditional Density Estimation • haldensify</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Highly Adaptive Lasso Conditional Density Estimation">
<meta property="og:description" content="haldensify">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">haldensify</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/intro_haldensify.html">Highly Adaptive Lasso Conditional Density Estimation</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/nhejazi/haldensify/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Highly Adaptive Lasso Conditional Density Estimation</h1>
                        <h4 class="author">
<a href="https://nimahejazi.org">Nima Hejazi</a> and <a href="https://www.sph.emory.edu/faculty/profile/#!dbenkes">David Benkeser</a>
</h4>
            
            <h4 class="date">2021-07-03</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/nhejazi/haldensify/blob/master/vignettes/intro_haldensify.Rmd"><code>vignettes/intro_haldensify.Rmd</code></a></small>
      <div class="hidden name"><code>intro_haldensify.Rmd</code></div>

    </div>

    
    
<div id="background-and-motivation" class="section level1">
<h1 class="hasAnchor">
<a href="#background-and-motivation" class="anchor"></a>Background and Motivation</h1>
<p>In causal inference problems, both classical estimators (e.g., based on inverse probability weighting) and doubly robust estimators (e.g., one-step estimation, targeted minimum loss estimation) require estimation of the propensity score, a nuisance parameter corresponding to the treatment mechanism. While exposures of interest may often be continuous-valued, most approaches opt to discretize the exposure so as to estimate effects based on categorical exposures – such a simplification is often done out of convenience, to avoid estimation of the <em>generalized propensity score</em> <span class="citation">(<span class="citeproc-not-found" data-reference-id="hirano2004propensity"><strong>???</strong></span>; <span class="citeproc-not-found" data-reference-id="imai2004causal"><strong>???</strong></span>)</span>, which is a conditional density function. The <code>haldensify</code> package introduces a flexible approach for estimating such conditional density functions, using the highly adaptive lasso (HAL), a nonparametric regression function that has been proven to converge to a given target function(al) at <span class="math inline">\(n^{-1/3}\)</span>-rate under minimal conditions.</p>
<p>Consider data generated by typical cohort sampling <span class="math inline">\(O = (W, A, Y)\)</span>, where <span class="math inline">\(W\)</span> is a vector of baseline covariates, A is a continuous-valued exposure, and <span class="math inline">\(Y\)</span> is an outcome of interest. Estimation of the generalized propensity score <span class="math inline">\(q_{0,A}\)</span> corresponds to estimating the conditional density of <span class="math inline">\(A\)</span> given <span class="math inline">\(W = w\)</span>. A simple strategy for estimating this nuisance function is to assume a parametric working model and use parametric regression to generate suitable density estimates. For example, one could operate under the working assumption that <span class="math inline">\(A\)</span> given <span class="math inline">\(W\)</span> follows a Gaussian distribution with homoscedastic variance and mean <span class="math inline">\(\sum_{j=1}^p \beta_j \phi_j(W)\)</span>, where <span class="math inline">\(\phi = (\phi_j : j)\)</span> are user-selected basis functions and <span class="math inline">\(\beta = (\beta_j : j)\)</span> are unknown regression parameters. In this case, a density estimate would be generated by fitting a linear regression of <span class="math inline">\(A\)</span> on <span class="math inline">\(\phi(W)\)</span> to estimate the conditional mean of <span class="math inline">\(A\)</span> given <span class="math inline">\(W\)</span>, paired with an estimate of the variance of <span class="math inline">\(A\)</span>. Then, the estimated conditional density would be given by the density of a Gaussian distribution evaluated at these estimates. Unfortunately, most such approaches do not allow for flexible modeling of <span class="math inline">\(q_{0,A}\)</span>. This motivated our development of a novel and flexible procedure for constructing conditional density estimates <span class="math inline">\(q_{n,A}(a \mid w)\)</span> of <span class="math inline">\(A\)</span> given <span class="math inline">\(W = w\)</span> (possibly subject to observation-level weights), evaluated at <span class="math inline">\(a \in \mathcal{A}\)</span>.</p>
</div>
<div id="pooled-hazards-conditional-density-estimation" class="section level1">
<h1 class="hasAnchor">
<a href="#pooled-hazards-conditional-density-estimation" class="anchor"></a>Pooled hazards conditional density estimation</h1>
<p>As consistent estimation of the generalized propensity score is an integral part of constructing estimators of the causal effects of continuous-valued exposures, our conditional density estimator, built around the HAL regression function, may be quite useful in flexibly constructing such estimates. We note that proposals for the data adaptive estimation of such quantities are sparse in the literature (e.g., <span class="citation">(<span class="citeproc-not-found" data-reference-id="zhu2015boosting"><strong>???</strong></span>)</span>). Notably, <span class="citation">Dı́az and van der Laan (2011)</span> gave a proposal for constructing semiparametric estimators of such a target quantity based on exploiting the relationship between the hazard and density functions. Our proposal builds upon theirs in several key ways:</p>
<ol style="list-style-type: decimal">
<li>we adjust their algorithm so as to incorporate sample-level weights, necessary for making use of sample-level weights (e.g., inverse probability of censoring weighting); and</li>
<li>we replace their use of an arbitrary classification model with the HAL regression function.</li>
</ol>
<p>While our first modification is general and may be applied to the estimation strategy of <span class="citation">Dı́az and van der Laan (2011)</span>, our latter contribution requires adjusting the penalization aspect of HAL regression models so as to respect the use of a loss function appropriate for density estimation on the hazard scale.</p>
<p>To build an estimator of a conditional density, <span class="citation">Dı́az and van der Laan (2011)</span> considered discretizing the observed <span class="math inline">\(a \in A\)</span> based on a number of bins <span class="math inline">\(T\)</span> and a binning procedure (e.g., including the same number of points in each bin or forcing bins to be of the same length). We note that the choice of the tuning parameter <span class="math inline">\(T\)</span> corresponds roughly to the choice of bandwidth in classical kernel density estimation; this will be made clear upon further examination of the proposed algorithm. The data <span class="math inline">\(\{A, W\}\)</span> are reformatted such that the hazard of an observed value <span class="math inline">\(a \in A\)</span> falling in a given bin may be evaluated via standard classification techniques. In fact, this proposal may be viewed as a re-formulation of the classification problem into a corresponding set of hazard regressions: <span class="math display">\[\begin{align*}
   \mathbb{P} (a \in [\alpha_{t-1}, \alpha_t) \mid W) =&amp; \mathbb{P} (a \in
   [\alpha_{t-1}, \alpha_t) \mid A \geq \alpha_{t-1}, W) \times  \\ &amp;
   \prod_{j = 1}^{t -1} \{1 - \mathbb{P} (a \in [\alpha_{j-1}, \alpha_j)
   \mid A \geq \alpha_{j-1}, W) \},
\end{align*}\]</span> where the probability that a value of <span class="math inline">\(a \in A\)</span> falls in a bin <span class="math inline">\([\alpha_{t-1}, \alpha_t)\)</span> may be directly estimated from a standard classification model. The likelihood of this model may be re-expressed in terms of the likelihood of a binary variable in a data set expressed through a repeated measures structure. Specifically, this re-formatting procedure is carried out by creating a data set in which any given observation <span class="math inline">\(A_i\)</span> appears (repeatedly) for as many intervals <span class="math inline">\([\alpha_{t-1}, \alpha_t)\)</span> that there are prior to the interval to which the observed <span class="math inline">\(a\)</span> belongs. A new binary outcome variable, indicating <span class="math inline">\(A_i \in [\alpha_{t-1}, \alpha_t)\)</span>, is recorded as part of this new data structure. With the re-formatted data, a pooled hazard regression, spanning the support of <span class="math inline">\(A\)</span> is then executed. Finally, the conditional density estimator <span class="math display">\[\begin{equation*}
   q_{n, \alpha}(a \mid W) = \frac{\mathbb{P}(a \in [\alpha_{t-1}, \alpha_t)
      \mid W)}{(\alpha_t - \alpha_{t-1})},
\end{equation*}\]</span> for <span class="math inline">\(\alpha_{t-1} \leq a \le \alpha_t\)</span>, may be constructed. As part of this procedure, the hazard estimates are mapped to density estimates through rescaling of the estimates by the bin size (<span class="math inline">\(\alpha_t - \alpha_{t-1}\)</span>).</p>
<p>In its original proposal, a key element of this procedure was the use of any arbitrary classification procedure for estimating <span class="math inline">\(\mathbb{P}(a \in [\alpha_{t-1}, \alpha_t) \mid W)\)</span>, facilitating the incorporation of flexible, data adaptive estimators. We alter this proposal in two ways,</p>
<ol style="list-style-type: decimal">
<li>replacing the arbitrary estimator of <span class="math inline">\(\mathbb{P}(a \in [\alpha_{t-1}, \alpha_t) \mid W)\)</span> with HAL regression, and</li>
<li>accommodating the use of sample-level weights, making it possible for the resultant conditional density estimator to achieve a convergence rate with respect to a loss-based dissimilarity of <span class="math inline">\(n^{-1/3}\)</span> under only mild assumptions.</li>
</ol>
<p>Our procedure alters the HAL regression function to use a loss function tailored for estimation of the hazard, invoking <span class="math inline">\(\ell_1\)</span>-penalization in a manner consistent with this loss.</p>
</div>
<div id="example" class="section level1">
<h1 class="hasAnchor">
<a href="#example" class="anchor"></a>Example</h1>
<p>First, let’s load a few required packages and set a seed for our example.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/nhejazi/haldensify">haldensify</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">75681</span><span class="op">)</span></code></pre></div>
<p>Next, we’ll generate a simple simulated dataset. The function <code>make_example_data</code>, defined below, generates a baseline covariate <span class="math inline">\(W\)</span> and a continuous-valued exposure variable <span class="math inline">\(A\)</span>, whose mean is a function of <span class="math inline">\(W\)</span>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">make_example_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n_obs</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">n_obs</span>, <span class="op">-</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span>
  <span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n_obs</span>, mean <span class="op">=</span> <span class="va">W</span>, sd <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span>
  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>A <span class="op">=</span> <span class="va">A</span>, W <span class="op">=</span> <span class="va">W</span><span class="op">)</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Now, let’s simulate our data and take a quick look at it:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># number of observations in our simulated dataset</span>
<span class="va">n_obs</span> <span class="op">&lt;-</span> <span class="fl">200</span>
<span class="va">example_data</span> <span class="op">&lt;-</span> <span class="fu">make_example_data</span><span class="op">(</span><span class="va">n_obs</span><span class="op">)</span>

<span class="co"># quick look at the data</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">example_data</span><span class="op">)</span></code></pre></div>
<pre><code>##             A           W
## 1:  2.3063922  2.24687273
## 2:  0.9297479  0.91025531
## 3: -3.2443382 -2.98696024
## 4: -0.1842217 -0.01204378
## 5:  3.2756387  3.59166824
## 6: -2.9132139 -3.02363838</code></pre>
<p>Next, we’ll fit our pooled hazards conditional density estimator via the <code>haldensify</code> wrapper function. Based on underlying theory and simulation experiments, we recommend setting a relatively large number of bins and using a binning strategy that accommodates creating such a large number of bins.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">haldensify_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/haldensify.html">haldensify</a></span><span class="op">(</span>
  A <span class="op">=</span> <span class="va">example_data</span><span class="op">$</span><span class="va">A</span>,
  W <span class="op">=</span> <span class="va">example_data</span><span class="op">$</span><span class="va">W</span>,
  n_bins <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">20</span><span class="op">)</span>,
  grid_type <span class="op">=</span> <span class="st">"equal_range"</span>,
  lambda_seq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.1</span>, <span class="op">-</span><span class="fl">10</span>, length <span class="op">=</span> <span class="fl">500</span><span class="op">)</span><span class="op">)</span>,
  <span class="co"># the following are passed to hal9001::fit_hal() internally</span>
  max_degree <span class="op">=</span> <span class="fl">5</span>,
  num_knots <span class="op">=</span> <span class="cn">NULL</span>,
  smoothness_orders <span class="op">=</span> <span class="fl">0</span>,
  reduce_basis <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">n_obs</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">haldensify_fit</span></code></pre></div>
<pre><code>##          coef                term
##  1:  4.015834         (Intercept)
##  2:  8.219963  [ I(W &gt;= -3.305) ]
##  3:  7.080282  [ I(bin_id &gt;= 9) ]
##  4: -6.906777  [ I(W &gt;= -3.393) ]
##  5:  6.111346  [ I(bin_id &gt;= 7) ]
##  6:  5.984919   [ I(W &gt;= 0.474) ]
##  7:  5.615845  [ I(bin_id &gt;= 2) ]
##  8:  5.536335  [ I(bin_id &gt;= 4) ]
##  9:  5.375681 [ I(bin_id &gt;= 13) ]
## 10:  5.270633  [ I(W &gt;= -0.267) ]</code></pre>
<p>Having constructed the conditional density estimator, we can examine the empirical risk over the grid of choices of the <span class="math inline">\(L_1\)</span> regularization parameter <span class="math inline">\(\lambda\)</span>. To do this, we can simply call the available <code>plot</code> method, which uses the cross-validated conditional density fits in the <code>cv_tuning_results</code> slot of the <code>haldensify</code> object. For example,</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p_risk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">haldensify_fit</span><span class="op">)</span>
<span class="va">p_risk</span></code></pre></div>
<p><img src="intro_haldensify_files/figure-html/plot_risk_haldensify-1.png" width="700"></p>
<p>Finally, we can predict the conditional density over the grid of observed values <span class="math inline">\(A\)</span> across different elements of the support <span class="math inline">\(W\)</span>. We do this using the <code>predict</code> method of <code>haldensify</code> and plot the results below.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># predictions to recover conditional density of A|W</span>
<span class="va">new_a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">4</span>, <span class="fl">4</span>, by <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span>
<span class="va">new_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  a <span class="op">=</span> <span class="va">new_a</span>,
  w_neg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">new_a</span><span class="op">)</span><span class="op">)</span>,
  w_zero <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">new_a</span><span class="op">)</span><span class="op">)</span>,
  w_pos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">new_a</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span><span class="op">)</span>
<span class="va">new_dat</span><span class="op">[</span>, <span class="va">pred_w_neg</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">haldensify_fit</span>, new_A <span class="op">=</span> <span class="va">new_dat</span><span class="op">$</span><span class="va">a</span>,
                                new_W <span class="op">=</span> <span class="va">new_dat</span><span class="op">$</span><span class="va">w_neg</span><span class="op">)</span><span class="op">]</span>
<span class="va">new_dat</span><span class="op">[</span>, <span class="va">pred_w_zero</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">haldensify_fit</span>, new_A <span class="op">=</span> <span class="va">new_dat</span><span class="op">$</span><span class="va">a</span>,
                                 new_W <span class="op">=</span> <span class="va">new_dat</span><span class="op">$</span><span class="va">w_zero</span><span class="op">)</span><span class="op">]</span>
<span class="va">new_dat</span><span class="op">[</span>, <span class="va">pred_w_pos</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">haldensify_fit</span>, new_A <span class="op">=</span> <span class="va">new_dat</span><span class="op">$</span><span class="va">a</span>,
                                new_W <span class="op">=</span> <span class="va">new_dat</span><span class="op">$</span><span class="va">w_pos</span><span class="op">)</span><span class="op">]</span>

<span class="co"># visualize results</span>
<span class="va">dens_dat</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/melt.data.table.html">melt</a></span><span class="op">(</span><span class="va">new_dat</span>, id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span>,
                  measure.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pred_w_pos"</span>, <span class="st">"pred_w_zero"</span>, <span class="st">"pred_w_neg"</span><span class="op">)</span><span class="op">)</span>

<span class="va">p_dens</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">dens_dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">a</span>, y <span class="op">=</span> <span class="va">value</span>, colour <span class="op">=</span> <span class="va">variable</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html">stat_function</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">dnorm</span>, args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="op">-</span><span class="fl">2</span>, sd <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span>,
                colour <span class="op">=</span> <span class="st">"blue"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html">stat_function</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">dnorm</span>, args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span>,
                colour <span class="op">=</span> <span class="st">"darkgreen"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html">stat_function</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">dnorm</span>, args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fl">2</span>, sd <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span>,
                colour <span class="op">=</span> <span class="st">"red"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>
    x <span class="op">=</span> <span class="st">"Observed value of W"</span>,
    y <span class="op">=</span> <span class="st">"Estimated conditional density"</span>,
    title <span class="op">=</span> <span class="st">"Conditional density estimates q(A|W)"</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span>
<span class="va">p_dens</span></code></pre></div>
<p><img src="intro_haldensify_files/figure-html/plot_haldensify-1.png" width="700"></p>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-diaz2011super">
<p>Dı́az, Iván, and Mark J van der Laan. 2011. “Super Learner Based Conditional Density Estimation with Application to Marginal Structural Models.” <em>The International Journal of Biostatistics</em> 7 (1): 1–20.</p>
</div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Nima Hejazi, David Benkeser, Mark van der Laan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
